# 工作台多班次与时间模拟测试指南

## 一、多班次支持

### 功能说明
系统现在支持医生一天有多个班次（如上午门诊 + 下午门诊），会根据当前时间智能选择应该显示的班次卡片。

### 选择逻辑
1. **优先级1**：如果有已签到但未签退的班次，显示该班次
2. **优先级2**：显示当前时间段内的班次（开始前30分钟到结束后2小时）
3. **优先级3**：如果当前时间在所有班次之前，显示第一个班次
4. **优先级4**：如果当前时间在所有班次之后，显示最后一个班次

### 示例场景
假设医生有两个班次：
- **上午门诊**：08:00 - 12:00
- **下午门诊**：13:30 - 17:30

| 当前时间 | 显示班次 | 原因 |
|---------|---------|------|
| 06:00 | 上午门诊 | 所有班次之前 |
| 07:35 | 上午门诊 | 上午门诊窗口内（07:30-14:00） |
| 12:30 | 上午门诊 | 上午门诊签退窗口内 |
| 13:00 | 下午门诊 | 下午门诊窗口内（13:00-19:30） |
| 18:00 | 下午门诊 | 下午门诊签退窗口内 |
| 20:00 | 下午门诊 | 所有班次之后 |

---

## 二、时间模拟器使用指南

### 开启条件
只在 **开发环境** (`NODE_ENV === 'development'`) 下显示。

### 工作原理
时间模拟器会：
1. **影响班次选择**：根据模拟时间决定显示哪个班次
2. **影响卡片状态**：根据模拟时间判断是"待签到""已签到""待签退"还是"已签退"
3. **影响时间窗口判断**：签到签退按钮的可用性和提示信息都基于模拟时间

### 使用方法

#### 1. 找到时间模拟器
在工作台页面顶部，你会看到一个紫色渐变的面板：

```
🕒 时间模拟器（仅开发）
[输入框: HH:mm]  [应用]  [重置]
当前模拟: 实际时间
```

#### 2. 输入模拟时间
在输入框中输入你想测试的时间，格式为 `HH:mm`，例如：
- `07:30` - 测试上午班次签到前
- `08:00` - 测试上午班次开始时
- `08:15` - 测试上午班次签到后
- `12:00` - 测试上午班次结束时
- `13:00` - 测试下午班次签到前
- `17:00` - 测试下午班次进行中
- `19:30` - 测试下午班次签退窗口

#### 3. 点击"应用"
点击应用按钮后，系统会：
- 使用你输入的时间来判断应该显示哪个班次
- 自动切换到对应的班次卡片
- 显示对应的卡片状态

#### 4. 点击"重置"
恢复为实际系统时间。

---

## 三、测试场景清单

### 场景1：上午门诊 - 待签到（签到前）
```
模拟时间: 07:30
预期结果: 
- 显示"上午门诊"卡片
- 状态为"待签到"（蓝色卡片）
- 显示班次信息：08:00 - 12:00
- 显示值班地点
- 点击"签到"按钮 → 弹出"未到签到时间"
```

### 场景2：上午门诊 - 可签到
```
模拟时间: 08:00
预期结果:
- 显示"上午门诊"卡片
- 状态为"待签到"
- 点击签到按钮 → 可以成功签到（需要真实调用后端）
```

### 场景3：上午门诊 - 签到窗口内
```
模拟时间: 08:15
预期结果:
- 显示"上午门诊"卡片
- 如果已签到：自动显示"已签到 工作中"（白色卡片，绿色左边框）
- 如果未签到：显示"待签到"，点击可以签到
```

### 场景4：上午门诊 - 工作中（超过签到窗口）
```
模拟时间: 10:00
预期结果:
- 如果已签到：显示"已签到 工作中"
  - 显示已工作时长
  - 显示距离下班时间
- 如果未签到：显示"待签到"
  - 点击签到按钮 → 弹出"已超过签到时间"
```

### 场景5：上午门诊 - 待签退
```
模拟时间: 12:00
预期结果:
- 如果已签到：自动变为"待签退"（蓝色卡片）
  - 可以点击"签退"按钮
- 如果未签到：仍显示"待签到"
  - 点击签到 → "已超过签到时间"
```

### 场景5：上午门诊 - 签退窗口后
```
模拟时间: 14:10
预期结果:
- 如果未签退：仍显示"待签退"，但点击签退会提示"已超过签退时间"
- 如果已签退：显示"已签退，辛苦了！"
```

### 场景6：切换到下午门诊
```
模拟时间: 13:00
预期结果:
- 自动切换显示"下午门诊"卡片
- 状态为"待签到"
- 显示班次信息：13:30 - 17:30
```

### 场景7：下午门诊 - 可签到
```
模拟时间: 13:30
预期结果:
- 显示"下午门诊"卡片
- 可以正常签到
```

### 场景8：两个班次都已签退
```
模拟时间: 20:00
预期结果:
- 显示"下午门诊"卡片（最后一个班次）
- 状态为"已签退"
```

---

## 四、测试步骤示例

### 完整测试流程

#### Step 1: 测试上午班次签到前
```
1. 打开工作台页面
2. 在时间模拟器输入：07:30
3. 点击"应用"
4. 验证：显示上午门诊待签到卡片
5. 尝试点击签到按钮
6. 验证：弹出"未到签到时间"提示
```

#### Step 2: 测试上午班次签到
```
1. 修改模拟时间为：08:00
2. 点击"应用"
3. 点击"签到"按钮
4. 验证：签到成功，卡片变为"已签到 工作中"
```

#### Step 3: 测试上午班次签到后
```
1. 修改模拟时间为：10:00
2. 点击"应用"
3. 验证：
   - 显示"已签到 工作中"状态
   - 显示已工作时长
   - 显示距离下班时间
```

#### Step 4: 测试上午班次签退
```
1. 修改模拟时间为：12:00
2. 点击"应用"
3. 验证：卡片变为"待签退"
4. 点击"签退"按钮
5. 验证：签退成功，卡片变为"已签退"
```

#### Step 5: 测试切换到下午班次
```
1. 修改模拟时间为：13:00
2. 点击"应用"
3. 验证：
   - 自动切换到"下午门诊"卡片
   - 显示待签到状态
   - 显示下午班次的时间和地点
```

#### Step 6: 测试下午班次签到
```
1. 修改模拟时间为：13:30
2. 点击"应用"
3. 点击"签到"按钮
4. 验证：下午班次签到成功
```

#### Step 7: 测试零点后重置
```
1. 修改模拟时间为：00:01
2. 点击"应用"
3. 验证：
   - 所有班次状态重置
   - 显示第一个班次（上午门诊）
   - 状态为"待签到"
```

---

## 五、注意事项

### 1. 开发环境检查
确保你的项目运行在开发模式：
```bash
npm run dev:h5
# 或
npm run dev:mp-weixin
```

### 2. 时间格式
- ✅ 正确：`08:00`, `13:30`, `17:45`
- ❌ 错误：`8:00`, `8`, `0800`, `08:00:00`

### 3. 数据刷新
- 应用模拟时间后，卡片会自动切换
- 如果没有变化，可以尝试下拉刷新页面

### 4. 实际签到签退
- 即使使用模拟时间，实际签到签退仍然使用真实时间
- 模拟时间只影响UI显示和时间窗口判断

### 5. 生产环境
- 时间模拟器在生产环境会自动隐藏
- 所有功能恢复为使用实际系统时间

---

## 六、常见问题

### Q1: 为什么修改时间后卡片没变化？
**A**: 检查：
1. 时间格式是否正确（HH:mm）
2. 是否点击了"应用"按钮
3. 后端返回的班次数据是否正确

### Q2: 如何测试跨班次场景？
**A**: 
1. 先用时间模拟器设置到第一个班次（如 08:00）
2. 完成签到
3. 修改时间到第二个班次（如 13:30）
4. 观察卡片自动切换到下午班次

### Q3: 模拟时间会影响真实签到吗？
**A**: 不会。模拟时间只影响：
- 卡片显示哪个班次
- 时间窗口判断（是否可以签到/签退）
- 实际签到签退的时间戳仍然使用真实系统时间

### Q4: 如何测试零点后重置逻辑？
**A**: 
1. 设置模拟时间为 `23:59`
2. 完成当天最后一个班次的签退
3. 修改模拟时间为 `00:01`
4. 验证卡片重置为"待签到"

---

## 七、调试技巧

### 1. 查看控制台日志
打开浏览器控制台，查看：
```
[Workbench] shifts raw: {...}  // 班次数据
[Workbench] 选择的班次: {...}  // 当前显示的班次
```

### 2. 查看班次列表
在控制台输入：
```javascript
this.shifts  // 查看所有班次
this.currentShiftData  // 查看当前选中的班次数据
```

### 3. 强制刷新
如果UI没有更新，在控制台执行：
```javascript
this.$forceUpdate()
```

---

## 八、快捷测试时间表

| 场景 | 时间 | 用途 |
|-----|------|------|
| 凌晨 | `00:30` | 测试零点重置 |
| 上午签到前 | `07:30` | 测试未到签到时间 |
| 上午签到时 | `08:00` | 测试上午签到 |
| 上午工作中 | `10:00` | 测试工作中状态 |
| 上午下班 | `12:00` | 测试上午签退 |
| 午休 | `12:30` | 测试班次切换 |
| 下午签到前 | `13:00` | 测试下午班次显示 |
| 下午签到时 | `13:30` | 测试下午签到 |
| 下午工作中 | `15:00` | 测试下午工作状态 |
| 下午下班 | `17:30` | 测试下午签退 |
| 超过签退窗口 | `20:00` | 测试超时提示 |

---

**祝测试顺利！** 🎉

如有问题，请检查：
1. 是否在开发环境运行
2. 后端是否返回了正确的班次数据
3. 时间格式是否正确
4. 控制台是否有错误信息
